<!DOCTYPE html><html lang="zh-CN"><head hexo-theme="https://github.com/volantis-x/hexo-theme-volantis/tree/4.3.1"><meta charset="utf-8"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="preload" href="/css/first.css" as="style"><title>Volantis 主题部署 Pjax - 枋柚梓的猫会发光</title><meta name="keywords" content="Hexo,Pjax,Volantis"><meta name="description" content="本篇文章记录了我对 Volantis 主题做 Pjax 兼容的种种，大抵算是种记录吧~"><link rel="alternate" href="/atom.xml" title="枋柚梓的猫会发光" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/img/favicon.png"><link rel="stylesheet" href="/css/first.css"><link rel="stylesheet" href="/css/style.css" media="print" onload='this.media="all",this.onload=null'><noscript><link rel="stylesheet" href="/css/style.css"></noscript><script>document.addEventListener("error",(function(t){const a=t.target,e=t.target.parentElement,r=e.classList.toString(),s=e.parentElement.classList.toString();"img"===a.tagName.toLowerCase()&&(a.classList.add("fix-cursor-default","error"),"fancybox"===r&&"fancybox"===s?(e.parentElement.classList.add("hideFancybox"),e.parentElement.classList.remove("fancybox"),e.classList.remove("fancybox")):"img-bg"===r&&"img-wrap"===s?e.parentElement.classList.add("hideFancybox"):"author"===r?e.parentElement.classList.add("fix-author-imgError"):-1!=r.indexOf("tk-avatar")&&e.parentElement.classList.add("fix-avatar-imgError"))}),!0)</script></head><body><header id="l_header" class="l_header auto shadow show" style="opacity:0"><div class="container"><div id="wrapper"><div class="nav-sub"><p class="title"></p><ul class="switcher nav-list-h m-phone" id="pjax-header-nav-list"><li><a id="s-comment" class="fad fa-comments fa-fw" target="_self" href="javascript:void(0)"></a></li><li><a id="s-toc" class="s-toc fad fa-list fa-fw" target="_self" href="javascript:void(0)"></a></li></ul></div><div class="nav-main"><a class="title flat-box" target="_self" href="/"><i class="fad fa-cannabis logoColor"></i> INKSS</a><div class="menu navigation"><ul class="nav-list-h m-pc"><li><a class="menuitem flat-box faa-parent animated-hover" href="/" id="home"><i class="fad fa-helmet-battle fa-fw"></i> 首页</a></li><li><a class="menuitem flat-box faa-parent animated-hover"><i class="fad fa-cube fa-fw"></i> 导航</a><ul class="list-v"><li><a class="menuitem flat-box faa-parent animated-hover" href="/categories/" id="categories"><i class="fad fa-folder-open fa-fw"></i> 分类</a></li><li><a class="menuitem flat-box faa-parent animated-hover" href="/tags/" id="tags"><i class="fad fa-tags fa-fw"></i> 标签</a></li><li><a class="menuitem flat-box faa-parent animated-hover" href="/archives/" id="archives"><i class="fad fa-archive fa-fw"></i> 归档</a></li></ul></li><li><a class="menuitem flat-box faa-parent animated-hover"><i class="fad fa-fist-raised fa-fw"></i> 更多</a><ul class="list-v"><li><a class="menuitem flat-box faa-parent animated-hover" href="/about/" id="about"><i class="fad fa-skull fa-fw"></i> 关于我</a></li><li><a class="menuitem flat-box faa-parent animated-hover" href="/notes/" id="notes"><i class="fad fa-flower-daffodil fa-fw"></i> 笔记本</a></li><hr><li><a class="menuitem flat-box faa-parent animated-hover" href="/foreverblog/" id="foreverblog"><i class="fad fa-glass-cheers fa-fw"></i> 十年之约</a></li><li><a class="menuitem flat-box faa-parent animated-hover" href="/friends/" id="friends"><i class="fad fa-comment-smile fa-fw"></i> 小伙伴们</a></li><li><a class="menuitem flat-box header toggle-mode-btn"><i class="fad fa-bat fa-fw"></i> 暗黑模式</a></li><li></li></ul></li><li><a class="menuitem flat-box faa-parent animated-hover" href="/info/" id="info"><i class="fad fa-comet fa-fw"></i> 留言</a></li></ul></div><div class="m_search"><form name="searchform" class="form u-search-form"><i class="icon fad fa-search fa-fw"></i> <input type="text" class="input u-search-input" placeholder="想找些什么~"></form></div><ul class="switcher nav-list-h m-phone"><li><a class="s-search fad fa-search fa-fw" target="_self" href="javascript:void(0)"></a></li><li><a class="s-menu fad fa-bars fa-fw" target="_self" href="javascript:void(0)"></a><ul class="menu-phone list-v navigation white-box"><li><a class="menuitem flat-box faa-parent animated-hover" href="/" id="home"><i class="fad fa-helmet-battle fa-fw"></i> 首页</a></li><li><a class="menuitem flat-box faa-parent animated-hover"><i class="fad fa-cube fa-fw"></i> 导航</a><ul class="list-v"><li><a class="menuitem flat-box faa-parent animated-hover" href="/categories/" id="categories"><i class="fad fa-folder-open fa-fw"></i> 分类</a></li><li><a class="menuitem flat-box faa-parent animated-hover" href="/tags/" id="tags"><i class="fad fa-tags fa-fw"></i> 标签</a></li><li><a class="menuitem flat-box faa-parent animated-hover" href="/archives/" id="archives"><i class="fad fa-archive fa-fw"></i> 归档</a></li></ul></li><li><a class="menuitem flat-box faa-parent animated-hover"><i class="fad fa-fist-raised fa-fw"></i> 更多</a><ul class="list-v"><li><a class="menuitem flat-box faa-parent animated-hover" href="/about/" id="about"><i class="fad fa-skull fa-fw"></i> 关于我</a></li><li><a class="menuitem flat-box faa-parent animated-hover" href="/notes/" id="notes"><i class="fad fa-flower-daffodil fa-fw"></i> 笔记本</a></li><hr><li><a class="menuitem flat-box faa-parent animated-hover" href="/foreverblog/" id="foreverblog"><i class="fad fa-glass-cheers fa-fw"></i> 十年之约</a></li><li><a class="menuitem flat-box faa-parent animated-hover" href="/friends/" id="friends"><i class="fad fa-comment-smile fa-fw"></i> 小伙伴们</a></li><li><a class="menuitem flat-box header toggle-mode-btn"><i class="fad fa-bat fa-fw"></i> 暗黑模式</a></li><li></li></ul></li><li><a class="menuitem flat-box faa-parent animated-hover" href="/info/" id="info"><i class="fad fa-comet fa-fw"></i> 留言</a></li></ul></li></ul></div></div></div></header><div id="l_body"><div id="l_cover"><div id="none" class="cover-wrapper post blank" style="display:none"><div class="cover-bg lazyload placeholder" data-bg></div><div id="scroll-down" style="display:none"><i class="fa fa-chevron-down scroll-down-effects"></i></div></div></div><div id="safearea"><div class="body-wrapper" id="pjax-container"><div id="l_main" class><article class="cus-indent article post white-box reveal md shadow article-type-post" id="post" itemscope itemprop="blogPost"><div class="article-meta" id="top"></div><p class="p center logo large"><em>Volantis 主题部署 Pjax <sup>应用篇</sup></em></p><br><br><p class="p center">前言：本篇定位于主题的各类处理上，理论篇见 <a href="/blog/80b5f235/">Hexo 博客部署 Pjax 局部刷新</a>。</p><p class="p center">不多废话，那么，让我们开始吧！</p><h2 id="一、主题分析">一、主题分析</h2><h3 id="1-1-整体性分析">1.1 整体性分析</h3><p>在对主题做兼容时，最废心力的莫过于处理导航栏、封面这块，理论篇里已经分析过了，Pjax 需要重载的区域为文章主体和侧边栏，而封面、导航栏、页脚是不需要进行重载的。其中麻烦程度以导航栏为最，绑定了大量的按钮、事件等等，此外考虑到移动端适配的缘故，导航栏事实上是有两个存在的，均需要对其处理。</p><p>而封面部分，早期我没有过于考虑去处理封面，原因是这样的：导航栏是嵌入在封面里的（代码层面），在设置为全屏封面下时，存在了全屏、半屏和无封三种情况，控制起来略有些麻烦。而且存在一个导航栏出现时机的问题，需要计算出浏览器在什么滚动高度下才放出导航栏显示，此外导航栏上还放着嵌套的菜单，这部分通过循环渲染出来，使用 hover 伪类控制其显示，偏偏这种情况 Javascript 又不好处理，在无封面到有封面切换时留下了已经激活的菜单小尾巴。</p><p>至于页脚，目前唯一的动态数据为访问量的 PV 显示，这部分是直接由 class 定位赋值的，无需过多烦恼，倒是原主题中各个页脚的引用是分散的，需要统一抽离出来。这里插一嘴侧边栏，侧边栏因为是可配置项，从栏目到显示都是可配置的，过于麻烦，还是放在了重载区域内处理吧。</p><h3 id="1-2-插件分析">1.2 插件分析</h3><p>一个个来细数，大抵以下几种：搜索、评论、懒加载、图片弹出层、代码复制、背景幻灯片、音乐播放器、按钮涟漪动画、页面平滑滚动、公式、不蒜子计数、网址预加载等。</p><p>这其中，有些无需处理，有些简单的封装成函数重新调用一下即可，而有些则就需要特意分析处理了。除了以上几个插件外，主题里还有两个核心 JS 文件，一为 <code>app.js</code> ，另一为 <code>search.js</code>。这两个前者主要控制导航栏、按钮的激活等；后者则是用于搜索、渲染搜索结果查询等等。前者需要细致的处理，后者只需要修改下搜索结果列，点击搜索结果时，手动发送出一个 Pjax 请求，因为结果列是后期渲染的，没有在页面初始化时被 Pjax 监控到，需要手动发送跳转请求完成无刷新的跳转。</p><h2 id="二、插件的处理">二、插件的处理</h2><p>此部分，以几类特殊的插件作以说明，未提及者类似处理，相应文件主要位于 <em>_partial/scripts.ejs</em>。</p><h3 id="2-1-函数封装与调用">2.1 函数封装与调用</h3><p>如前文中所说，一些插件只需要封装成函数，在 Pjax 的 complete 事件中，重新调用即可；而另一些，单独的 JS 的文件引用，无额外函数设置的，只需要重新加载，以下简单介绍一番。</p><p>（1）Fancybox &amp; lazyload 此两者，均为对图像部分的处理，用于弹窗放大显示和懒加载，其中对 Fancybox 的处理是将初始化函数封装为函数，加载完成时重新调用一下即可，相关代码：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/inkss/volantis/blob/master-theme/layout/_third-party/fancybox.ejs">fancybox.ejs</a>（另：Fancybox 担任了图片描述信息的显示，已改为默认启用）。而 Lazyload 需要特殊处理，不过相关兼容已经解决，只需要确认自己的 <em>hexo-lazyload-image</em> 版本大于等于 <em>1.0.9</em> ，接着在全局配置文件下，为 lazyload 添加配置项： <code>isSPA: true</code>。</p><p>（2）不蒜子，用于文章/站点的计数，无各类配置项目，此类处理为在 JS 引用时加特殊标志 <code>data-pjax</code>，在 Pjax 的 complete 事件中，利用此标志将其移除，并重新加载，类似于：</p><figure class="highlight js"><figcaption><span>不蒜子</span></figcaption><table><tr><td class="code"><pre><span class="line marked">&lt;script defer src=<span class="string">&quot;&lt;%- theme.plugins.busuanzi %&gt;&quot;</span> data-pjax&gt;&lt;/script&gt;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line">$(<span class="string">&#x27;script[data-pjax], .pjax-reload script&#x27;</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span></span><br><span class="line marked"><span class="function">  <span class="title">$</span>(<span class="params"><span class="built_in">this</span></span>).<span class="title">parent</span>(<span class="params"></span>).<span class="title">append</span>(<span class="params">$(<span class="built_in">this</span>).remove()</span>)</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>（3）Valine，对评论的处理就很有意思了，先谈谈 <em>scripts.ejs</em> 这个文件，与 <em>.js</em> 相比，它可以利用 Hexo 的函数引用主题配置或者页面中的 <em>Front-matter</em> 配置，这部分属性是在渲染阶段读取，并写入到 <em>html</em> 页面。而对于 Valine 来说，在本主题中，是允许不同页面自定义 placeholder 和 path 的，但是！这部分代码不在 Pjax 重加载区域内，也就是意味着丢失了这部分自定义值。自然而然，既然此处无法重载，那就放到能够重载到的位置。</p><p>这里我利用 ejs 的文件特征，建立了一个 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/inkss/volantis/blob/master-theme/layout/_third-party/pjaxdata.ejs">pjaxdata.ejs</a>，将一些值藏（<em>display: none</em>）在这里，写入到 div 标签中，通过 <code>$.trim($('#id').text()</code> 获取值。至于为什么不写成 <code>var xxx = &lt;%=xxx%&gt;</code> 的形式，那是因为在代码压缩时对于这类只声明不调用的变量，会被直接删掉的…</p><p>综上，对与动态的变量处理是这个样子的：</p><figure class="highlight js"><figcaption><span>pjax_valine()</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pjax_valine</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> valinePath = $.trim($(<span class="string">&#x27;#valine-path&#x27;</span>).text()) === <span class="string">&quot;none&quot;</span> ?</span><br><span class="line">    <span class="built_in">window</span>.location.pathname : $.trim($(<span class="string">&#x27;#valine-path&#x27;</span>).text());</span><br><span class="line">  <span class="keyword">var</span> valinePlaceholder = $.trim($(<span class="string">&#x27;#valine-placeholder&#x27;</span>).text()) === <span class="string">&quot;none&quot;</span> ?</span><br><span class="line">    <span class="string">&quot;&lt;%= theme.comments.valine.placeholder %&gt;&quot;</span> : $.trim($(<span class="string">&#x27;#valine-placeholder&#x27;</span>).text());</span><br><span class="line">  <span class="keyword">var</span> ALLPATH = <span class="string">&#x27;&lt;%= theme.comments.valine.path %&gt;&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span>(ALLPATH != <span class="string">&#x27;&#x27;</span>) valinePath = ALLPATH;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> valine = <span class="keyword">new</span> Valine();</span><br><span class="line">  valine.init(&#123;</span><br><span class="line">    el: <span class="string">&#x27;#valine_container&#x27;</span>,</span><br><span class="line">    meta: meta,</span><br><span class="line marked">    placeholder: valinePlaceholder,</span><br><span class="line marked">    path: valinePath,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  )&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（4）大部分插件都可以循着以上三个的思路完成兼容，更多内容可在 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/inkss/volantis/blob/master-theme/layout/_partial/scripts.ejs"><strong>scripts.ejs</strong></a> 查看。</p><h3 id="2-2-Pjax-事件">2.2 Pjax 事件</h3><p>说了第三方插件后，来谈谈 Pjax 本身吧，Pjax 在处理重载区域时，有一个要求，便是被重载部分必须为所有页面都存在（特指选择器），否则便会失败触发强制刷新。而在 Pjax 自带的四个事件中 <code>send</code> 、<code>complete</code> 、<code>success</code> 、<code>error</code> ，send 和 complete 可以用来处理一些函数的解绑与注册，此外还可以用来控制加载动画的显隐，error 可以在监听到失败时做个提醒呀之类的，success 用的不多，不是很需要。</p><p>这里附录一下本次兼容的 Pjax 函数内容吧：</p><details blue><summary> Pjax 函数</summary><div class="content"><figure class="highlight js"><figcaption><span>pjax 函数</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> pjax;</span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  pjax = <span class="keyword">new</span> Pjax(&#123;</span><br><span class="line">    elements: <span class="string">&#x27;a[href]:not([href^=&quot;#&quot;]):not([href=&quot;javascript:void(0)&quot;]):not([pjax-fancybox])&#x27;</span>,</span><br><span class="line">    selectors: [</span><br><span class="line">      <span class="string">&quot;title&quot;</span>,</span><br><span class="line">      <span class="string">&quot;#pjax-container&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    cacheBust: <span class="literal">false</span>,   <span class="comment">// url 地址追加时间戳，用以避免浏览器缓存</span></span><br><span class="line">    timeout: <span class="string">&#x27;5000&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">&#x27;pjax:send&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.stop(); <span class="comment">// 相当于点击了浏览器的停止按钮</span></span><br><span class="line">  <span class="built_in">window</span>.subData = <span class="literal">null</span>; <span class="comment">// 移除标题（用于一二级导航栏切换处）</span></span><br><span class="line">  $.fancybox.close();    <span class="comment">// 关闭弹窗</span></span><br><span class="line">  $(<span class="string">&#x27;.nav-main&#x27;</span>).find(<span class="string">&#x27;.list-v&#x27;</span>).not(<span class="string">&#x27;.menu-phone&#x27;</span>).css(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;none&quot;</span>); <span class="comment">// 移除小尾巴</span></span><br><span class="line">  $(<span class="string">&#x27;.menu-phone.list-v&#x27;</span>).css(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;none&quot;</span>); <span class="comment">// 移除小尾巴</span></span><br><span class="line">  $(<span class="string">&#x27;.l_header .switcher .s-search&#x27;</span>).removeClass(<span class="string">&#x27;active&#x27;</span>); <span class="comment">// 关闭移动端激活的搜索框</span></span><br><span class="line">  $(<span class="string">&#x27;.l_header&#x27;</span>).removeClass(<span class="string">&#x27;z_search-open&#x27;</span>); <span class="comment">// 关闭移动端激活的搜索框</span></span><br><span class="line">  $(<span class="string">&#x27;.wrapper&#x27;</span>).removeClass(<span class="string">&#x27;sub&#x27;</span>); <span class="comment">// 跳转页面时关闭二级导航</span></span><br><span class="line">  $(<span class="built_in">window</span>).unbind(<span class="string">&#x27;resize&#x27;</span>);    <span class="comment">// 解绑</span></span><br><span class="line">  $(<span class="built_in">window</span>).unbind(<span class="string">&#x27;scroll&#x27;</span>);    <span class="comment">// 解绑</span></span><br><span class="line">  $(<span class="built_in">window</span>).unbind(<span class="string">&#x27;click&#x27;</span>);     <span class="comment">// 解绑</span></span><br><span class="line">  $(<span class="built_in">document</span>).unbind(<span class="string">&#x27;scroll&#x27;</span>);  <span class="comment">// 解绑</span></span><br><span class="line">  NProgress.start();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">&#x27;pjax:complete&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 关于百度统计对 SPA 页面的处理：</span></span><br><span class="line">  <span class="comment">// 方案一：百度统计&gt;管理&gt;单页应用设置中，打开开启按钮即可对SPA进行统计。 https://tongji.baidu.com/web/help/article?id=324</span></span><br><span class="line">  <span class="comment">// 方案二：取消注释下列代码。 https://tongji.baidu.com/web/help/article?id=235</span></span><br><span class="line">  <span class="comment">// &lt;% if (config.baidu_analytics_key) &#123; %&gt;</span></span><br><span class="line">  <span class="comment">// _hmt.push([&#x27;_trackPageview&#x27;, document.location.pathname]);</span></span><br><span class="line">  <span class="comment">// &lt;% &#125; %&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关于谷歌统计对 SPA 页面的处理：</span></span><br><span class="line">  <span class="comment">// 当应用以动态方式加载内容并更新地址栏中的网址时，也应该更新通过 gtag.js 存储的网页网址。</span></span><br><span class="line">  <span class="comment">// https://developers.google.cn/analytics/devguides/collection/gtagjs/single-page-applications?hl=zh-cn</span></span><br><span class="line">  &lt;% <span class="keyword">if</span> (config.google_analytics_key) &#123; %&gt;</span><br><span class="line">    <span class="built_in">window</span>.dataLayer = <span class="built_in">window</span>.dataLayer || [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">gtag</span>(<span class="params"></span>)</span>&#123;dataLayer.push(<span class="built_in">arguments</span>);&#125;</span><br><span class="line">    gtag(<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;&lt;%- config.google_analytics_key %&gt;&#x27;</span>, &#123;<span class="string">&#x27;page_path&#x27;</span>: <span class="built_in">document</span>.location.pathname&#125;);</span><br><span class="line">  &lt;% &#125; %&gt;</span><br><span class="line">  </span><br><span class="line">  $(<span class="string">&#x27;.nav-main&#x27;</span>).find(<span class="string">&#x27;.list-v&#x27;</span>).not(<span class="string">&#x27;.menu-phone&#x27;</span>).removeAttr(<span class="string">&quot;style&quot;</span>,<span class="string">&quot;&quot;</span>); <span class="comment">// 移除小尾巴的移除</span></span><br><span class="line">  $(<span class="string">&#x27;.menu-phone.list-v&#x27;</span>).removeAttr(<span class="string">&quot;style&quot;</span>,<span class="string">&quot;&quot;</span>); <span class="comment">// 移除小尾巴的移除</span></span><br><span class="line">  $(<span class="string">&#x27;script[data-pjax], .pjax-reload script&#x27;</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="built_in">this</span>).parent().append($(<span class="built_in">this</span>).remove());</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    pjax_fancybox();</span><br><span class="line">    &lt;% <span class="keyword">if</span> (theme.plugins.scrollreveal &amp;&amp; theme.plugins.scrollreveal.js) &#123; %&gt;</span><br><span class="line">      pjax_scrollrebeal();</span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">    &lt;% <span class="keyword">if</span> (theme.plugins.clipboard &amp;&amp; (theme.style.body.highlight.copy_btn == <span class="literal">true</span>)) &#123; %&gt;</span><br><span class="line">      pjax_initCopyCode();</span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">    &lt;% <span class="keyword">if</span> (enableValine)&#123; %&gt;</span><br><span class="line">      pjax_valine();</span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">    &lt;% <span class="keyword">if</span> (enableMiniValine)&#123; %&gt;</span><br><span class="line">      pjax_minivaline();</span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e);</span><br><span class="line">  &#125;</span><br><span class="line">  NProgress.done();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">&#x27;pjax:error&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  NProgress.done();</span><br><span class="line">  <span class="built_in">window</span>.location.href = event.triggerElement.href;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div></details><h2 id="三、主题核心代码处理">三、主题核心代码处理</h2><p>主要为两个 js 文件，内容很翔实，改动量不小，慢慢更新系列~</p><h3 id="3-1-搜索">3.1 搜索</h3><p>在前面我就说了，搜索结果是后期渲染上的，所以没有被 Pjax 整成自己的样子（哈哈），所以那些结果标签点过去立马来个刷新跳转，故此部分便只需要对这点处理下就行啦。这里需要利用 Pjax 的 <code>pjax.refresh([el])</code> 函数：</p><p>Use this method to bind Pjax to children of a DOM element that didn’t exist when Pjax was initialised e.g. content inserted dynamically by another library or script. If called with no arguments, Pjax will parse the entire document again to look for newly-inserted elements.</p><figure class="highlight js"><figcaption><span>refresh([el])</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// Inside a callback or Promise that runs after new DOM content has been inserted</span></span><br><span class="line"><span class="keyword">var</span> newContent = <span class="built_in">document</span>.querySelector(<span class="string">&quot;.new-content&quot;</span>);</span><br><span class="line"></span><br><span class="line">pjax.refresh(newContent);</span><br></pre></td></tr></table></figure><p>也就是重新加载 #u-search 区域，接着监听 send 事件，关闭搜索窗口：</p><figure class="highlight js"><figcaption><span>Pjax 处理</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">html += <span class="string">&quot;&lt;script&gt;try&#123;pjax.refresh(document.querySelector(&#x27;#u-search&#x27;))&#125;catch(e)&#123;console.log(e)&#125;&lt;/script&gt;&quot;</span>;</span><br><span class="line">html += <span class="string">&quot;&lt;script&gt;document.addEventListener(&#x27;pjax:send&#x27;,function()&#123;$(&#x27;#u-search&#x27;).fadeOut(500);$(&#x27;body&#x27;).removeClass(&#x27;modal-active&#x27;)&#125;);&lt;/script&gt;&quot;</span>;</span><br></pre></td></tr></table></figure><h3 id="3-2-导航栏">3.2 导航栏</h3><p>先放链接：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/inkss/volantis/blob/master-theme/source/js/app.js"><strong>app.js</strong></a>，看心情再决定补不补思路。</p><h3 id="3-3-封面">3.3 封面</h3><p>是这样的，原主题对封面的处理是通过读取页面配置来控制渲染，大概三种不同渲染场景，而在 Pjax 处理时简化为两种场景，全局不开启封面和开启封面，别的就通过代码来控制样式啦。样式处理无非是控制显示、隐藏，但是呢，还需要控制导航栏出现时机，这部分在上一小节讲。</p><figure class="highlight js"><figcaption><span>封面控制</span></figcaption><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">if</span>(<span class="string">&quot;&lt;%=frontMatterCover%&gt;&quot;</span> == <span class="string">&quot;none&quot;</span>) &#123;  <span class="comment">// 移除封面</span></span><br><span class="line">      <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;cover&#x27;</span>)[<span class="number">0</span>].style.display = <span class="string">&quot;none&quot;</span>;  </span><br><span class="line">      <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;l_body&#x27;</span>)[<span class="number">0</span>].classList.add(<span class="string">&quot;nocover&quot;</span>);</span><br><span class="line">      <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;l_header&#x27;</span>,<span class="string">&#x27;cover-wrapper&#x27;</span>)[<span class="number">0</span>].classList.add(<span class="string">&quot;show&quot;</span>); </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="string">&quot;&lt;%=frontMatterCover%&gt;&quot;</span> == <span class="string">&quot;blog&quot;</span>) &#123;  <span class="comment">// 半屏</span></span><br><span class="line">          <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;cover&#x27;</span>)[<span class="number">0</span>].classList.remove(<span class="string">&quot;full&quot;</span>);</span><br><span class="line">          <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;cover&#x27;</span>)[<span class="number">0</span>].classList.add(<span class="string">&quot;half&quot;</span>);</span><br><span class="line">          <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;scroll-down&#x27;</span>)[<span class="number">0</span>].style.display = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;&lt;%=frontMatterCover%&gt;&quot;</span> == <span class="string">&quot;docs&quot;</span>) &#123; <span class="comment">// 全屏</span></span><br><span class="line">          <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;cover&#x27;</span>)[<span class="number">0</span>].classList.remove(<span class="string">&quot;half&quot;</span>);</span><br><span class="line">          <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;cover&#x27;</span>)[<span class="number">0</span>].classList.add(<span class="string">&quot;full&quot;</span>);</span><br><span class="line">          <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;scroll-down&#x27;</span>)[<span class="number">0</span>].style.display = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;cover&#x27;</span>)[<span class="number">0</span>].style.display = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;l_body&#x27;</span>,<span class="string">&#x27;show&#x27;</span>)[<span class="number">0</span>].classList.remove(<span class="string">&quot;nocover&quot;</span>);</span><br><span class="line">      <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;l_header&#x27;</span>,<span class="string">&#x27;cover-wrapper&#x27;</span>)[<span class="number">0</span>].classList.remove(<span class="string">&quot;show&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>为了照顾显示效果，这部分处理是放在封面加载之后文章加载之前，好处是不会出现闪一下的效果（默认整个封面是隐藏的），坏处是此时 Jquery 没加载，得用原生 JS 来写。</p><h2 id="四、后续">四、后续</h2><p>没有后续，完结撒花~</p><div class="footer"></div><div class="article-meta" id="bottom"><div class="new-meta-box"><div class="new-meta-item meta-tags"><a class="tag" href="/tags/Hexo/" rel="nofollow"><i class="fad fa-hashtag fa-fw" aria-hidden="true"></i><p>Hexo</p></a></div><div class="new-meta-item meta-tags"><a class="tag" href="/tags/Pjax/" rel="nofollow"><i class="fad fa-hashtag fa-fw" aria-hidden="true"></i><p>Pjax</p></a></div><div class="new-meta-item meta-tags"><a class="tag" href="/tags/Volantis/" rel="nofollow"><i class="fad fa-hashtag fa-fw" aria-hidden="true"></i><p>Volantis</p></a></div><div class="new-meta-item date"><a class="notlink"><i class="fad fa-calendar-alt fa-fw" aria-hidden="true"></i><p>发布于：2020年5月17日</p></a></div></div></div><div class="prev-next"><a class="prev" href="/blog/481358a6/"><p class="title"><i class="fad fa-chevron-left" aria-hidden="true"></i>记一次 Ubuntu 20.04 LTS 安装体验</p><p class="content"> 老规矩，操作系统信息走一遍，PS 经过些许定制，图中显示不代表原版效果 一、序言 我也算是用了很久的 Ubuntu 系统（这个很久大概是一两年左右），初接触在 Ubuntu 14 ，正式入坑为...</p></a><a class="next" href="/blog/b2b02edd/"><p class="title">WSL 之宝塔面板的部署<i class="fad fa-chevron-right" aria-hidden="true"></i></p><p class="content">在很早之前，我就有一个需求，需要一个小型灵活的本地服务器，因为目的在于轻便、快捷，所以倘若搭建 Nginx 到本机又有些浪费性能，过于臃肿，毕竟不是服务器。而小型服务器的话如 Tomcat 启动...</p></a></div></article><article class="post white-box reveal shadow" id="comments"><p ct><i class="fad fa-comments"></i> 评论</p><div id="twikoo_container"><i class="fad fa-cog fa-spin fa-fw fa-2x"></i></div></article></div><aside id="l_side"><section class="widget text shadow desktop"><header><i class="fad fa-user-robot fa-fw" aria-hidden="true"></i> <span class="name">公告信息</span></header><div class="content"><div id="destroyRightContent" style="display:none"><p>本站默认替换了右键菜单，唤醒原系统菜单： <kbd>Ctrl</kbd> + <kbd>右键</kbd> ~</p><p class="article">关闭自定义右键：<span id="destroyRightMenu" class="btn"><a class="button" href="javascript:;" title="注销右键">注销右键</a></span></p></div><p id="initRightContent" class="article" style="display:none">激活自定义右键：<span id="initRightMenu" class="btn"><a class="button" href="javascript:;" title="激活右键">激活右键</a></span></p></div></section><section class="widget tagcloud shadow desktop mobile"><header><a href="/tags/"><i class="fad fa-tags fa-fw" aria-hidden="true"></i> <span class="name">标签列表</span></a></header><div class="content"> <a href="/tags/Adguard/" style="font-size:14px;color:#999">Adguard</a> <a href="/tags/Angular/" style="font-size:16.67px;color:#828282">Angular</a> <a href="/tags/Arrow-Function/" style="font-size:14px;color:#999">Arrow Function</a> <a href="/tags/Cities-Skylines/" style="font-size:14px;color:#999">Cities: Skylines</a> <a href="/tags/Clipboard/" style="font-size:14px;color:#999">Clipboard</a> <a href="/tags/Cloud-Studio/" style="font-size:14px;color:#999">Cloud Studio</a> <a href="/tags/Code-server/" style="font-size:14px;color:#999">Code-server</a> <a href="/tags/Const/" style="font-size:14px;color:#999">Const</a> <a href="/tags/DNS/" style="font-size:14px;color:#999">DNS</a> <a href="/tags/DOH/" style="font-size:14px;color:#999">DOH</a> <a href="/tags/Desctructuring/" style="font-size:14px;color:#999">Desctructuring</a> <a href="/tags/Docker/" style="font-size:14px;color:#999">Docker</a> <a href="/tags/ES6/" style="font-size:14px;color:#999">ES6</a> <a href="/tags/Git/" style="font-size:16.67px;color:#828282">Git</a> <a href="/tags/Hexo/" style="font-size:22px;color:#555">Hexo</a> <a href="/tags/JS/" style="font-size:14px;color:#999">JS</a> <a href="/tags/Java/" style="font-size:14px;color:#999">Java</a> <a href="/tags/Linux/" style="font-size:19.33px;color:#6c6c6c">Linux</a> <a href="/tags/NG-ZORRO/" style="font-size:16.67px;color:#828282">NG-ZORRO</a> <a href="/tags/Office/" style="font-size:14px;color:#999">Office</a> <a href="/tags/Permissions-API/" style="font-size:14px;color:#999">Permissions-API</a> <a href="/tags/Pjax/" style="font-size:16.67px;color:#828282">Pjax</a> <a href="/tags/Portaine/" style="font-size:14px;color:#999">Portaine</a> <a href="/tags/Powershell/" style="font-size:14px;color:#999">Powershell</a> <a href="/tags/Proxy/" style="font-size:14px;color:#999">Proxy</a> <a href="/tags/Shell/" style="font-size:14px;color:#999">Shell</a> <a href="/tags/Steam/" style="font-size:16.67px;color:#828282">Steam</a> <a href="/tags/Ubuntu/" style="font-size:14px;color:#999">Ubuntu</a> <a href="/tags/Ubuntu-18-04/" style="font-size:14px;color:#999">Ubuntu 18.04</a> <a href="/tags/Volantis/" style="font-size:14px;color:#999">Volantis</a> <a href="/tags/WSL/" style="font-size:14px;color:#999">WSL</a> <a href="/tags/%E5%88%86%E9%A1%B5/" style="font-size:14px;color:#999">分页</a> <a href="/tags/%E5%88%9B%E6%84%8F%E5%B7%A5%E5%9D%8A/" style="font-size:14px;color:#999">创意工坊</a> <a href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size:16.67px;color:#828282">微信小程序</a> <a href="/tags/%E6%89%93%E5%8C%85/" style="font-size:14px;color:#999">打包</a> <a href="/tags/%E6%98%BE%E5%8D%A1%E9%A9%B1%E5%8A%A8/" style="font-size:14px;color:#999">显卡驱动</a> <a href="/tags/%E7%A0%B4%E8%A7%A3/" style="font-size:14px;color:#999">破解</a> <a href="/tags/%E7%BB%84%E4%BB%B6/" style="font-size:14px;color:#999">组件</a> <a href="/tags/%E7%BD%91%E5%8D%A1%E9%A9%B1%E5%8A%A8/" style="font-size:14px;color:#999">网卡驱动</a> <a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size:19.33px;color:#6c6c6c">网站</a> <a href="/tags/%E8%81%94%E6%83%B3Y7000P/" style="font-size:14px;color:#999">联想Y7000P</a> <a href="/tags/%E9%9A%90%E7%A7%81/" style="font-size:14px;color:#999">隐私</a></div></section><section class="widget toc-wrapper shadow desktop mobile" id="toc-div"><header><i class="fad fa-list fa-fw" aria-hidden="true"></i> <span class="name">本文目录</span></header><div class="content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BB%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">一、主题分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%95%B4%E4%BD%93%E6%80%A7%E5%88%86%E6%9E%90"><span class="toc-text">1.1 整体性分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%8F%92%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-text">1.2 插件分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%8F%92%E4%BB%B6%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-text">二、插件的处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%87%BD%E6%95%B0%E5%B0%81%E8%A3%85%E4%B8%8E%E8%B0%83%E7%94%A8"><span class="toc-text">2.1 函数封装与调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Pjax-%E4%BA%8B%E4%BB%B6"><span class="toc-text">2.2 Pjax 事件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%B8%BB%E9%A2%98%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E5%A4%84%E7%90%86"><span class="toc-text">三、主题核心代码处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%90%9C%E7%B4%A2"><span class="toc-text">3.1 搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AF%BC%E8%88%AA%E6%A0%8F"><span class="toc-text">3.2 导航栏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%B0%81%E9%9D%A2"><span class="toc-text">3.3 封面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%90%8E%E7%BB%AD"><span class="toc-text">四、后续</span></a></li></ol></div></section></aside><script>window.pdata={},pdata.ispage=!0,pdata.postTitle="Volantis 主题部署 Pjax",pdata.commentPath="",pdata.commentPlaceholder="";var l_header=document.getElementById("l_header");l_header.classList.add("show")</script></div><footer class="footer clearfix"><br><br><div><div class="footerMax560"><p>博客内容遵循 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-pjax-state>「署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)」</a> 协议</p></div></div><div><div class="footerMax490">本站使用 <a href="https://github.com/volantis-x/hexo-theme-volantis" target="_blank" class="codename" rel="external nofollow noopener noreferrer" data-pjax-state>Volantis</a> 作为主题 | 由 <a href="https://hexo.io/zh-cn/" target="_blank" class="codename" rel="external nofollow noopener noreferrer" data-pjax-state>Hexo</a> 强力驱动 | <span>由腾讯云 <a href="https://cloud.tencent.com/product/cdn" target="_blank" class="codename" rel="external nofollow noopener noreferrer" data-pjax-state>CDN</a> 分发</span></div></div><div><div class="footerMax490">辽 ICP 备 <a href="https://beian.miit.gov.cn/" target="_blank" rel="external nofollow noopener noreferrer" style="cursor:wait">16006560</a> 号 | 辽公网安备 <a href="https://www.beian.gov.cn/" rel="external nofollow noopener noreferrer" target="_blank" style="cursor:wait">21021702000331</a> 号</div></div><div><div class="footerMax490">Copyright 2018 - 2021 szyink. All Rights Reserved</div></div><div><p><a href="/">枋柚梓的猫会发光</a></p></div><div><p><i class="fad fa-spider-black-widow"></i></p></div></footer><a id="s-top" class="fad fa-arrow-up fa-fw" href="javascript:void(0)"></a></div></div><div><script>function RunItem(){function t(t,e){this.name=e||t.name,this.run=()=>{try{t()}catch(t){console.log(t)}}}this.list=[],this.start=()=>{for(var t=0;t<this.list.length;t++)this.list[t].run()},this.push=(e,n)=>{var o=new t(e,n);this.list.push(o)}}function loadScript(t,e){setTimeout((function(){var n=document.getElementsByTagName("head")[0]||document.documentElement,o=document.createElement("script");o.setAttribute("type","text/javascript"),e&&(o.onload=e),o.setAttribute("src",t),n.appendChild(o)}))}window.volantis={},volantis.$={},volantis.pjax={},volantis.pjax.method={complete:new RunItem,error:new RunItem,send:new RunItem},volantis.pjax={...volantis.pjax,push:volantis.pjax.method.complete.push,error:volantis.pjax.method.error.push,send:volantis.pjax.method.send.push},volantis.dark={},volantis.dark.method={toggle:new RunItem},volantis.dark={...volantis.dark,push:volantis.dark.method.toggle.push};var loadCSS=function(t,e,n,o){var i,a=window.document,s=a.createElement("link");if(e)i=e;else{var r=(a.body||a.getElementsByTagName("head")[0]).childNodes;i=r[r.length-1]}var l=a.styleSheets;if(o)for(var d in o)o.hasOwnProperty(d)&&s.setAttribute(d,o[d]);s.rel="stylesheet",s.href=t,s.media="only x",function t(e){if(a.body)return e();setTimeout((function(){t(e)}))}((function(){i.parentNode.insertBefore(s,e?i:i.nextSibling)}));var u=function(t){for(var e=s.href,n=l.length;n--;)if(l[n].href===e)return t();setTimeout((function(){u(t)}))};function h(){s.addEventListener&&s.removeEventListener("load",h),s.media=n||"all"}return s.addEventListener&&s.addEventListener("load",h),s.onloadcssdefined=u,u(h),s}</script><script>loadCSS("/fonts/fontawesome/css/all.min.css"),loadCSS("https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10/build/styles/solarized-light.min.css")</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5/dist/jquery.min.js"></script><script>function pjax_fancybox(){$(".md .gallery").find("img").each((function(){var a=document.createElement("a");$(a).attr("class","fancybox"),$(a).attr("pjax-fancybox",""),$(a).attr("href",$(this).attr("src")),$(this).attr("data-original")&&$(a).attr("href",$(this).attr("data-original")),$(a).attr("data-fancybox","images");var t="";$(this).attr("alt")&&($(a).attr("data-caption",$(this).attr("alt")),t=$(this).attr("alt"));var n=document.createElement("div");$(n).addClass("fancybox"),$(this).wrap(n);var o=document.createElement("span");$(o).addClass("image-caption"),$(o).text(t),$(this).after(o),$(this).wrap(a)})),$(".md .gallery").find("img").fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1,closeClick:!0,helpers:{overlay:{closeClick:!0}},buttons:["zoom","close"]})}function SCload_fancybox(){0!=$(".md .gallery").find("img").length&&(loadCSS("https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"),loadScript("https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js",pjax_fancybox))}function Pjax_SCload_fancybox(){void 0===$.fancybox?SCload_fancybox():pjax_fancybox()}$((function(){SCload_fancybox()})),volantis.pjax.push(Pjax_SCload_fancybox),volantis.pjax.send(()=>{void 0!==$.fancybox&&$.fancybox.close()},"fancybox")</script><div id="rightmenu-wrapper"><ul class="list-v rightmenu" id="rightmenu-content"><li class="navigation menuNavigation-Content"><a class="nav icon-only fix-cursor-default" onclick="history.back()"><i class="fad fa-arrow-left fa-fw"></i></a><a class="nav icon-only fix-cursor-default" onclick="history.forward()"><i class="fad fa-arrow-right fa-fw"></i></a><a class="nav icon-only fix-cursor-default" onclick="window.location.reload()"><i class="fad fa-redo fa-fw"></i></a><a class="nav icon-only fix-cursor-default" href="/"><i class="fad fa-home fa-fw"></i></a></li><li class="option menuOption-Content"><a class="vlts-menu opt fix-cursor-default menu-Option" data-fn-type="copyText"><i class="fad fa-copy fa-fw"></i> 复制文本</a><a class="vlts-menu opt fix-cursor-default menu-Option" data-fn-type="copyPaste"><i class="fad fa-paste fa-fw"></i> 粘贴文本</a><a class="vlts-menu opt fix-cursor-default menu-Option" data-fn-type="copySelect"><i class="fad fa-object-ungroup fa-fw"></i> 全选文本</a><a class="vlts-menu opt fix-cursor-default menu-Option" data-fn-type="copyCut"><i class="fad fa-cut fa-fw"></i> 剪切文本</a><a class="vlts-menu opt fix-cursor-default menu-Option" data-fn-type="openTab"><i class="fad fa-external-link-square-alt fa-fw"></i> 在新标签页打开</a><a class="vlts-menu opt fix-cursor-default menu-Option" data-fn-type="copySrc"><i class="fad fa-image fa-fw"></i> 复制图片地址</a><a class="vlts-menu opt fix-cursor-default menu-Option" data-fn-type="copyImg"><i class="fad fa-images fa-fw"></i> 复制图片文件</a></li><hr class="menuLoad-Content"><li class="menuLoad-Content"><a class="vlts-menu fix-cursor-default" href="/info/" id="info"><i class="fad fa-fish fa-fw"></i> 留言版</a></li><li class="menuLoad-Content"><a class="vlts-menu fix-cursor-default" href="/foreverblog/" id="foreverblog"><i class="fad fa-glass-cheers fa-fw"></i> 十年之约</a></li><li class="menuLoad-Content"><a class="vlts-menu fix-cursor-default" href="/friends/" id="friends"><i class="fad fa-flower-daffodil fa-fw"></i> 我的朋友们</a></li><li class="menuLoad-Content"><a class="vlts-menu fix-cursor-default" href="/archives/" id="archives"><i class="fad fa-globe-asia fa-fw"></i> 文章归档</a></li><li class="menuLoad-Content"><a class="vlts-menu fix-cursor-default" href="/about/" id="about"><i class="fad fa-gingerbread-man fa-fw"></i> 关于我</a></li><hr class="menuLoad-Content"><li class="option menuOption-Content"><a class="vlts-menu fix-cursor-default" id="printHtml"><i class="fad fa-print fa-fw"></i> 打印页面</a></li><li class="option menuOption-Content"><a class="vlts-menu fix-cursor-default toggle-mode-btn" id="menuDarkBtn"><i class="fad fa-moon fa-fw"></i> 暗黑模式</a></li></ul></div><script>$((function(){rightMenu.init()}));const rightMenu=function(){const e={},t=document.getElementById("rightmenu-wrapper"),n=document.getElementById("rightmenu-content"),o=$("#printHtml"),i=$("#menuDarkBtn");$menuLoad=$(".menuLoad-Content"),$menuOption=$(".menuOption-Content");const c=$('.menu-Option[data-fn-type="copyText"]'),r=$('.menu-Option[data-fn-type="copyPaste"]'),a=$('.menu-Option[data-fn-type="copySelect"]'),s=$('.menu-Option[data-fn-type="copyCut"]'),l=$('.menu-Option[data-fn-type="copyHref"]'),d=$('.menu-Option[data-fn-type="copySrc"]'),u=$('.menu-Option[data-fn-type="copyImg"]'),h=$('.menu-Option[data-fn-type="openTab"]');return e.init=()=>{$(".menu-Option").hide()},e.initEvent=()=>{window.document.oncontextmenu=t=>t.ctrlKey||$(window).width()<=500?(e.hideMenu(),!0):e.popMenu(t),t.oncontextmenu=e=>(e.stopPropagation(),e.preventDefault(),!1),$(window).off("click.rightMenu").on("click.rightMenu",()=>{e.hideMenu()}),$(window).off("blur.rightMenu").on("blur.rightMenu",()=>{e.hideMenu()}),$(t).off("blur.rightMenu").on("blur.rightMenu",()=>{e.hideMenu()})},e.popMenu=o=>{let i=o.clientX,c=o.clientY,r=document.documentElement.clientWidth||document.body.clientWidth,a=document.documentElement.clientHeight||document.body.clientHeight;try{e.setMenuItem(o),$(t).focus(),t.style.display="block",t.style.zIndex="-2147483648";let s=n.offsetWidth,l=n.offsetHeight,d=i+s>r?i-s+10:i,u=c+l>a?c-l+10:c;t.style.left=d+"px",t.style.top=u+"px",t.style.zIndex="2147483648"}catch(e){return $(t).blur(),console.error(e),!0}return!1},e.setMenuItem=t=>{let n=!1;const g=t.target,m=window.getSelection().toString();if(h.hide(),i&&i.off("click.rightMenu").one("click.rightMenu",e=>{i.children().toggleClass("fad fa-moon"),i.children().toggleClass("fad fa-sun")}),$(g).is("input")||$(g).is("textarea")){const t=$(g).val();t.length>0?(a.show(),a.off("click.rightMenu").one("click.rightMenu",()=>{$(g).select()})):a.hide(),m?(s.show(),s.off("click.rightMenu").one("click.rightMenu",()=>{const n=g.selectionStart,o=g.selectionEnd;e.copyString(m),$(g).val(t.substring(0,n)+t.substring(o,t.length)),g.selectionStart=n,g.selectionEnd=n,$(g).focus()})):s.hide(),e.readClipboard().then(t=>{t?(r.show(),r.off("click.rightMenu").one("click.rightMenu",()=>{e.insertAtCaret($(g),t)})):r.hide()}).catch(e=>{console.error(e),r.hide()})}else a.hide(),r.hide(),s.hide();const p=g.href;p?(n=!0,l.show(),h.show(),l.off("click.rightMenu").one("click.rightMenu",()=>{e.copyString(p)}),h.off("click.rightMenu").one("click.rightMenu",()=>{window.open(p)})):l.hide();const f=g.currentSrc;f?(n=!0,d.show(),h.show(),u.show(),d.off("click.rightMenu").one("click.rightMenu",()=>{e.copyString(f)}),u.off("click.rightMenu").one("click.rightMenu",()=>{e.writeClipImg(t,()=>{volantis.message("操作提示","复制成功！","success")},e=>{volantis.message("操作提示","复制失败："+e,"error")})}),h.off("click.rightMenu").one("click.rightMenu",()=>{window.open(f)})):(d.hide(),u.hide()),m?(n=!0,c.show(),c.off("click.rightMenu").one("click.rightMenu",()=>{e.copyString(m)})):c.hide();const w=$(".article.post").html(),y=window.location.pathname;w?(o.show(),o.off("click.rightMenu").one("click.rightMenu",t=>{window.location.pathname===y?e.printHtml():e.hideMenu()})):o.hide(),n?$menuLoad.hide():$menuLoad.show()},e.hideMenu=()=>{t.style.display="none"},e.copyString=t=>{e.writeClipText(t).then(()=>{volantis.message("操作提示",t.length>120?t.substring(0,120)+"...":t,"info")}).catch(e=>{volantis.message("操作提示",e,"error")})},e.writeClipText=e=>{try{return navigator.clipboard.writeText(e).then(()=>Promise.resolve()).catch(e=>Promise.reject(e))}catch(t){const n=document.createElement("input");n.setAttribute("readonly","readonly"),document.body.appendChild(n),n.setAttribute("value",e),n.select();try{let e=document.execCommand("copy");return document.body.removeChild(n),e&&"unsuccessful"!==e?Promise.resolve():Promise.reject("复制文本失败!")}catch(e){return document.body.removeChild(n),Promise.reject("当前浏览器不支持复制功能，请检查更新或更换其他浏览器操作!")}}},e.writeClipImg=async function(e,t,n){const o=e.target.currentSrc,i=e.target.parentElement;try{const e=await fetch(o),i=await e.blob();await navigator.clipboard.write([new ClipboardItem({[i.type]:i})]).then(()=>{t()},e=>{console.error("图片复制失败：",e),n(e)})}catch(e){const o=document;try{if(o.body.createTextRange){const e=document.body.createTextRange();e.moveToElementText(i),e.select()}else if(window.getSelection){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(i),e.removeAllRanges(),e.addRange(t)}document.execCommand("copy"),window.getSelection().removeAllRanges(),t()}catch(e){console.error(e),n("不支持复制当前图片！")}}},e.readClipboard=async()=>{const e=await navigator.permissions.query({name:"clipboard-read"});return"granted"===e.state||"prompt"===e.state?navigator.clipboard.readText().then(e=>e).catch(e=>Promise.reject(e)):Promise.reject(e)},e.insertAtCaret=(e,t)=>{const n=e[0],o=n.selectionStart,i=n.selectionEnd;if(document.selection)e.focus(),document.selection.createRange().text=t,e.focus();else if(o||"0"==o){var c=n.scrollTop;n.value=n.value.substring(0,o)+t+n.value.substring(i,n.value.length),e.focus(),n.selectionStart=o+t.length,n.selectionEnd=o+t.length,n.scrollTop=c}else e.value+=t,e.focus()},e.printHtml=()=>{$("body").css({backgroundColor:"unset"}),$("#l_header").hide(),$("#l_cover").hide(),$("#l_side").hide(),$("#l_main").css({width:"100%"}),$("#post").css({"box-shadow":"none",background:"none",padding:"0"}),$("h1").css({"text-align":"center","font-weight":"600","font-size":"2rem","margin-bottom":"20px"}),$(".prev-next").hide(),$("#bottom").children().append('<div class="new-meta-item"><a class="tag" href="'+window.location.href+'" rel="nofollow" data-pjax-state=""><i class="fad fa-external-link fa-fw" aria-hidden="true"></i><p>本文地址：'+window.location.href+"</p></a></div>"),$("#comments").hide(),$("#s-top").hide(),$("footer").hide(),$("#rightmenu-wrapper").hide(),$("details").attr("open","true"),$(".tab-pane").css({display:"block"}),$(".tab-content").css({"border-top":"none"}),$(".highlight>table pre").css({"white-space":"pre-wrap","word-break":"break-all"}),$(".nav-tabs").hide(),$(".j-china-lantern").hide(),$(".fancybox img").css({height:"auto",weight:"auto"}),$("img").removeAttr("srcset data-srcset").removeClass("img lazyload loaded"),$(document).click(),setTimeout(()=>{window.print(),document.body.innerHTML="",window.location.reload()},50)},{init:(t=!1)=>{e.init(),e.initEvent(),t&&volantis.message("操作提示","自定义右键注册成功。","success")},destroy:(n=!1)=>{e.hideMenu(),$(window).off("click.rightMenu"),$(window).off("blur.rightMenu"),$(t).off("blur.rightMenu"),window.document.oncontextmenu=()=>!0,n&&volantis.message("操作提示","自定义右键注销成功。","success")}}}()</script><script>const rootElement=document.documentElement,darkModeStorageKey="user-color-scheme",rootElementDarkModeAttributeName="data-user-color-scheme",setLS=(e,t)=>{localStorage.setItem(e,t)},removeLS=e=>{localStorage.removeItem(e)},getLS=e=>localStorage.getItem(e),getModeFromCSSMediaQuery=()=>window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",resetRootDarkModeAttributeAndLS=()=>{var e;rootElement.removeAttribute("data-user-color-scheme"),e=darkModeStorageKey,localStorage.removeItem(e)},validColorModeKeys={dark:!0,light:!0},applyCustomDarkModeSettings=e=>{const t=e||getLS(darkModeStorageKey);getCustomDarkMode(),t===getModeFromCSSMediaQuery()?resetRootDarkModeAttributeAndLS():validColorModeKeys[t]?rootElement.setAttribute("data-user-color-scheme",t):resetRootDarkModeAttributeAndLS()},invertDarkModeObj={dark:"light",light:"dark"},getCustomDarkMode=()=>{let e=getLS(darkModeStorageKey);if(validColorModeKeys[e])e=invertDarkModeObj[e];else{if(null!==e)return;e=invertDarkModeObj[getModeFromCSSMediaQuery()]}volantis.dark.mode="dark"==e?"light":"dark"},toggleCustomDarkMode=()=>{let e=getLS(darkModeStorageKey);if(validColorModeKeys[e])e=invertDarkModeObj[e];else{if(null!==e)return;e=invertDarkModeObj[getModeFromCSSMediaQuery()]}var t,o;return t=darkModeStorageKey,o=e,localStorage.setItem(t,o),e};volantis.dark.toggle=()=>{const e=toggleCustomDarkMode();applyCustomDarkModeSettings(e),volantis.dark.method.toggle.start()};var btn=$(".toggle-mode-btn","#wrapper,#rightmenu-wrapper");function bindToggleButton(){btn.on("click",volantis.dark.toggle)}applyCustomDarkModeSettings(),document.addEventListener("DOMContentLoaded",bindToggleButton),volantis.pjax.push(bindToggleButton),volantis.pjax.send(()=>{btn.unbind("click")},"toggle-mode-btn-unbind")</script><script>function loadIssuesJS(){0!=$(".md").find(".issues-api").length&&loadScript("/js/issues.js")}$((function(){loadIssuesJS()})),volantis.pjax.push(()=>{"undefined"==typeof IssuesAPI&&loadIssuesJS()},"IssuesJS")</script><script defer="defer" src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script><script>window.lazyLoadOptions={elements_selector:".lazyload",threshold:0},window.addEventListener("LazyLoad::Initialized",(function(n){window.lazyLoadInstance=n.detail.instance}),!1),document.addEventListener("DOMContentLoaded",(function(){lazyLoadInstance.update()})),document.addEventListener("pjax:complete",(function(){lazyLoadInstance.update()}))</script><script async src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@2/js/instant_page.js" type="module" defer="defer" integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script>var clipboard=new ClipboardJS(".btn-copy",{target:function(e){return e.nextElementSibling}});function wait(e,i){window.setTimeout(e,i)}function pjax_initCopyCode(){if($(".highlight .code pre").length+$(".article pre code").length!=0){var e="";e+='<button class="btn-copy" data-clipboard-snippet="">',e+='<i class="fad fa-copy"></i><span>COPY</span>',e+="</button>",$(".highlight .code pre").before(e),$(".article pre code").before(e),clipboard.off("success").on("success",(function(e){let i=$(e.trigger);i.addClass("copied");let a=$(i.find("i"));a.removeClass("fa-copy"),a.addClass("fa-check-circle");let n=$(i.find("span"));n[0].innerText="COPIED",wait((function(){a.removeClass("fa-check-circle"),a.addClass("fa-copy"),n[0].innerText="COPY"}),2e3)})),clipboard.off("error").on("error",(function(e){e.clearSelection();let i=$(e.trigger);i.addClass("copy-failed");let a=$(i.find("i"));a.removeClass("fa-copy"),a.addClass("fa-times-circle");let n=$(i.find("span"));n[0].innerText="COPY FAILED",wait((function(){a.removeClass("fa-times-circle"),a.addClass("fa-copy"),n[0].innerText="COPY"}),2e3)}))}}$((function(){pjax_initCopyCode()})),volantis.pjax.push(pjax_initCopyCode)</script><script>function load_twikoo(){loadScript("https://cdn.jsdelivr.net/npm/twikoo@1.2.0",pjax_twikoo)}function pjax_twikoo(){if(!document.querySelectorAll("#twikoo_container")[0])return;let o=pdata.commentPath;if(0==o.length){o=""||"decodeURI(window.location.pathname)"}twikoo.init(Object.assign({js:"https://cdn.jsdelivr.net/npm/twikoo@1.2.0",path:null,envId:"twikoo-web-4g84uta0261cb889"},{el:"#twikoo_container",path:o}))}$((function(){document.querySelectorAll("#twikoo_container")[0]&&load_twikoo()})),volantis.pjax.push(()=>{"undefined"==typeof twikoo?load_twikoo():pjax_twikoo()},"twikoo")</script><script src="/js/app.js"></script><script>const SearchServiceimagePath="https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@master/img/",ROOT="/".endsWith("/")?"/":"//";function listenSearch(){customSearch=new HexoSearch({imagePath:SearchServiceimagePath})}function setSearchService(){listenSearch()}$(".input.u-search-input").one("focus",(function(){loadScript("/js/search/hexo.js",setSearchService)}))</script><script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10/build/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script>volantis.pjax.push(()=>{document.querySelectorAll("pre code").forEach(h=>{hljs.highlightBlock(h)})},"highlightjs")</script><script>volantis.message=(s,e,a,o)=>{if(void 0===$.message){loadCSS("/css/message.css"),loadScript("/js/message.js",()=>{t(s,e,a,o)})}else t(s,e,a,o);function t(s,e,a,o){$.message({title:s,message:e,type:a,autoClose:o})}}</script><script>function listennSidebarTOC(){const e=document.querySelectorAll(".toc li");if(!e.length)return;const t=[...e].map(e=>{const t=e.querySelector(".toc-link"),n=document.getElementById(decodeURI(t.getAttribute("href")).replace("#",""));return t.addEventListener("click",e=>{e.preventDefault(),window.scrollTo({top:n.offsetTop+100,behavior:"smooth"})}),n});!function n(o){o=Math.floor(o+1e4);let r=new IntersectionObserver((r,c)=>{let i=document.documentElement.scrollHeight+100;if(i>o)return c.disconnect(),void n(i);let l=function(e){let n=0,o=e[n];if(o.boundingClientRect.top>0)return n=t.indexOf(o.target),0===n?0:n-1;for(;n<e.length;n++){if(!(e[n].boundingClientRect.top<=0))return t.indexOf(o.target);o=e[n]}return t.indexOf(o.target)}(r);!function(e){if(e.classList.contains("active-current"))return;document.querySelectorAll(".toc .active").forEach(e=>{e.classList.remove("active","active-current")}),e.classList.add("active","active-current");let t=e.parentNode;for(;!t.matches(".toc");)t.matches("li")&&t.classList.add("active"),t=t.parentNode}(e[l])},{rootMargin:o+"px 0px -100% 0px",threshold:0});t.forEach(e=>{e&&r.observe(e)})}(document.documentElement.scrollHeight)}document.addEventListener("DOMContentLoaded",listennSidebarTOC),document.addEventListener("pjax:success",listennSidebarTOC)</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><div class="pjax-animate"><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><div id="loading-bar-wrapper"><script>NProgress.configure({parent:"#loading-bar-wrapper",trickleSpeed:100})</script></div><script>window.ShowLoading=function(){NProgress.start()},window.HideLoading=function(){NProgress.done()}</script><script>volantis.pjax.push(window.HideLoading,"HideLoading"),volantis.pjax.send(window.ShowLoading,"ShowLoading"),volantis.pjax.error(window.HideLoading,"HideLoading")</script></div><script>var pjax;document.addEventListener("DOMContentLoaded",(function(){pjax=new Pjax({elements:'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox])',selectors:["title","#l_cover","#pjax-container","#pjax-header-nav-list"],cacheBust:!1,timeout:5e3})})),document.addEventListener("pjax:send",(function(e){try{var n=window.location.pathname,t=e.triggerElement.href,a=[""];""!=a[0]&&a.forEach(e=>{-1==n.indexOf(e)&&-1==t.indexOf(e)||(window.location.href=t)})}catch(e){}volantis.$.switcher.removeClass("active"),volantis.$.header.removeClass("z_search-open"),volantis.$.wrapper.removeClass("sub"),volantis.$.topBtn.unbind("click"),$(".menu a","#l_header,#l_cover").unbind("click"),$(window).unbind("resize"),$(window).unbind("scroll"),$(document).unbind("scroll"),$(document).unbind("click"),$("body").unbind("click"),volantis.pjax.method.send.start()})),document.addEventListener("pjax:complete",(function(){$("script[data-pjax], .pjax-reload script").each((function(){$(this).parent().append($(this).remove())})),volantis.pjax.method.complete.start()})),document.addEventListener("pjax:error",(function(e){volantis.pjax.method.error.start(),window.location.href=e.triggerElement.href}))</script></div></body></html>